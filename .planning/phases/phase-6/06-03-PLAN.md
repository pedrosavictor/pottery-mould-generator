---
phase: 06-outer-mould-ring-assembly
plan: 03
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - js/workers/geometryWorker.js
  - js/app.js
  - index.html
autonomous: false

must_haves:
  truths:
    - "Pour hole is visible as a cylindrical opening through the ring at the bottom of the mould"
    - "User can adjust assembly clearance via a slider and the preview regenerates"
    - "User can adjust outer wall thickness via a slider"
    - "All mould parts are watertight solids suitable for 3D printing"
    - "Complete assembly displays correctly in both assembled and exploded views"
  artifacts:
    - path: "js/workers/geometryWorker.js"
      provides: "Pour hole cut from ring via makeCylinder + cut, clearance parameter wired through to addAssemblyFeatures"
      contains: "pourHole"
    - path: "js/app.js"
      provides: "Clearance slider wiring, outer wall thickness slider wiring"
      contains: "slider-clearance"
    - path: "index.html"
      provides: "Clearance slider (0.1-0.8mm), outer wall thickness slider"
      contains: "slider-clearance"
  key_links:
    - from: "index.html slider-clearance"
      to: "js/app.js mouldParams.clearance"
      via: "input event updates mouldParams and triggers regenerateMould()"
      pattern: "slider-clearance.*clearance"
    - from: "js/app.js mouldParams.clearance"
      to: "js/workers/geometryWorker.js addAssemblyFeatures()"
      via: "clearance passed through mouldParams to grooveRadius = ridgeRadius + clearance"
      pattern: "clearance"
---

<objective>
Add the pour hole to the ring, add clearance and outer wall thickness sliders to the UI, and perform a full visual verification of the complete mould assembly in both assembled and exploded views.

Purpose: The pour hole is essential for plaster casting -- without it there is no way to introduce plaster into the mould cavity. Clearance configuration lets users tune the fit for their specific 3D printer. This plan completes Phase 6 and delivers a fully configurable mould assembly.

Output: Pour hole in ring, clearance slider, outer wall thickness slider, verified complete assembly.
</objective>

<execution_context>
@/Users/victorhome_1/.claude/get-shit-done/workflows/execute-plan.md
@/Users/victorhome_1/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/phase-6/RESEARCH.md
@.planning/phases/phase-6/06-01-SUMMARY.md
@.planning/phases/phase-6/06-02-SUMMARY.md
@js/workers/geometryWorker.js
@js/app.js
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pour hole to ring and clearance/wall-thickness UI controls</name>
  <files>js/workers/geometryWorker.js, js/app.js, index.html</files>
  <action>
**A. Add pour hole to generateRing() in geometryWorker.js:**

After the ring solid is created (via buildAndRevolve) but BEFORE splitting, cut a cylindrical pour hole through the ring. The pour hole goes through the full ring thickness (Z direction), positioned at the midpoint of the ring's radial width, on the Y=0 split face.

In `generateRing()`, between the `buildAndRevolve()` call and the `splitSolid()` call, add:

```javascript
  // Pour hole: cylindrical hole through the ring for plaster introduction.
  // Positioned at the midpoint of ring radial width, on the Y=0 plane.
  // Diameter = 30mm (15mm radius) -- large enough for plaster to flow.
  const pourHoleRadius = mouldParams.pourHoleRadius || 15;
  const pourHoleMidR = (ringInnerRadius + ringOuterRadius) / 2;

  // Only add pour hole if the ring is wide enough (hole diameter < ring width)
  if (pourHoleRadius * 2 < (ringOuterRadius - ringInnerRadius) * 0.9) {
    const pourHoleTool = track(
      makeCylinder(
        pourHoleRadius,
        ringHeight + 4,  // extend beyond ring top and bottom to ensure clean cut
        [pourHoleMidR, 0, bottomZ - ringHeight - 2],
        [0, 0, 1]        // cylinder axis along Z (vertical)
      )
    );
    ringSolid = track(ringSolid.cut(pourHoleTool));
  }
```

IMPORTANT: The `ringSolid` variable must be declared with `let` (not `const`) since it is reassigned after the pour hole cut. Update the declaration from Plan 06-02 accordingly.

The pour hole is cut BEFORE splitting so that each half/quarter inherits the hole geometry. Since the hole is positioned at Y=0, the front half gets a semicircular notch on its Y=0 face and the back half gets the matching semicircular notch. This is the correct behavior -- the hole is accessible when the halves are assembled.

**B. Add clearance slider to index.html:**

In the `#mould-settings` div, after the split count selector (added in Plan 06-01), add:

```html
<div class="slider-field">
  <label for="slider-clearance">Assembly clearance</label>
  <input type="range" id="slider-clearance" min="0.1" max="0.8" step="0.05" value="0.3" />
  <span class="slider-value" id="val-clearance">0.3</span>
  <span class="slider-unit">mm</span>
</div>
```

**C. Add outer wall thickness slider to index.html:**

After the clearance slider, add:

```html
<div class="slider-field">
  <label for="slider-outer-wall">Outer wall</label>
  <input type="range" id="slider-outer-wall" min="1.5" max="5" step="0.1" value="2.4" />
  <span class="slider-value" id="val-outer-wall">2.4</span>
  <span class="slider-unit">mm</span>
</div>
```

**D. Wire clearance and outer wall thickness in app.js initMouldSettings():**

Add at the end of `initMouldSettings()`:

```javascript
  // Wire clearance slider
  const sliderClearance = document.getElementById('slider-clearance');
  const valClearance = document.getElementById('val-clearance');
  if (sliderClearance) {
    mouldParams.clearance = parseFloat(sliderClearance.value);
    sliderClearance.addEventListener('input', () => {
      const mm = parseFloat(sliderClearance.value);
      if (valClearance) valClearance.textContent = mm;
      mouldParams.clearance = mm;
      regenerateMould();
    });
  }

  // Wire outer wall thickness slider
  const sliderOuterWall = document.getElementById('slider-outer-wall');
  const valOuterWall = document.getElementById('val-outer-wall');
  if (sliderOuterWall) {
    mouldParams.outerWallThickness = parseFloat(sliderOuterWall.value);
    sliderOuterWall.addEventListener('input', () => {
      const mm = parseFloat(sliderOuterWall.value);
      if (valOuterWall) valOuterWall.textContent = mm;
      mouldParams.outerWallThickness = mm;
      regenerateMould();
    });
  }
```

**E. Ensure mouldParams includes all Phase 6 defaults in app.js:**

Verify the mouldParams object includes:

```javascript
const mouldParams = {
  shrinkageRate: 0.13,
  wallThickness: 2.4,
  slipWellType: 'regular',
  cavityGap: 25,
  splitCount: 2,
  outerWallThickness: 2.4,
  clearance: 0.3,
  ringHeight: 8,
  pourHoleRadius: 15,
};
```

The `ringHeight` and `pourHoleRadius` do not need UI sliders for v1 (sensible defaults). They can be exposed in a future "Advanced" panel if needed.
  </action>
  <verify>
1. Check pour hole in generateRing: `grep "pourHole\|pourHoleTool" js/workers/geometryWorker.js`
2. Check makeCylinder used for pour hole: `grep "makeCylinder.*pourHole" js/workers/geometryWorker.js`
3. Check pour hole cut before split: verify in code that the cut happens before splitSolid call
4. Check clearance slider in HTML: `grep "slider-clearance" index.html`
5. Check outer wall slider in HTML: `grep "slider-outer-wall" index.html`
6. Check clearance wiring in app.js: `grep "slider-clearance\|mouldParams.clearance" js/app.js`
7. Check outer wall wiring in app.js: `grep "slider-outer-wall\|mouldParams.outerWallThickness" js/app.js`
8. Check mouldParams has all fields: `grep "pourHoleRadius\|ringHeight\|clearance" js/app.js`
  </verify>
  <done>
Pour hole cut through ring at Y=0 split face before splitting (each half gets a semicircular notch). Clearance slider (0.1-0.8mm, default 0.3mm) and outer wall thickness slider (1.5-5mm, default 2.4mm) wired to regenerateMould(). All Phase 6 mould parameters have UI controls or sensible defaults.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 6 mould assembly: outer mould (cylindrical shell, halves/quarters), bottom ring (washer shape, matching splits), ridge/groove features on split faces, pour hole through ring, and all configuration controls (cavity gap, split count, clearance, outer wall thickness).
  </what-built>
  <how-to-verify>
1. Open the app in the browser (or refresh if already open).
2. Wait for WASM to initialize and the initial mould to generate.

**Outer mould verification:**
3. Verify the outer mould shell appears as a blue-grey cylinder surrounding the inner mould. There should be a visible gap (plaster cavity) between the inner mould and the outer mould.
4. Switch to Exploded view -- outer mould pieces should separate from the inner mould vertically.
5. Change "Mould split" dropdown to "Quarters (4 pieces)" -- the outer mould should split into 4 pieces instead of 2.
6. Drag the "Plaster cavity" slider -- the outer mould diameter should change. Smaller values bring the outer mould closer to the inner mould.

**Ring verification:**
7. Look at the bottom of the assembly -- a flat washer-shaped ring should be visible connecting the inner and outer mould bases.
8. In exploded view, the ring pieces should appear below the other parts.
9. The ring should also split into quarters when the outer mould is set to quarters.

**Assembly features verification:**
10. Zoom in on the split faces (where the halves/quarters meet at Y=0). Look for small cylindrical bumps (ridges) on one face and matching indentations (grooves) on the other face. The ridges should be visible at approximately 1/3 and 2/3 of the part height.

**Pour hole verification:**
11. Look at the ring from below or in exploded view -- there should be a circular hole (30mm diameter) through the ring, positioned where the split faces meet.

**Controls verification:**
12. Adjust "Assembly clearance" slider -- this should trigger regeneration (the groove width changes, though the visual difference at 0.3mm may be subtle).
13. Adjust "Outer wall" slider -- the outer mould wall should get thicker/thinner.
14. Toggle "Outer Mould" checkbox -- all outer pieces should hide/show.
15. Toggle "Ring" checkbox -- all ring pieces should hide/show.

**Profile change verification:**
16. Change a parametric slider (e.g., height or rim diameter) -- ALL parts should regenerate together (proof + inner mould + outer mould + ring).
  </how-to-verify>
  <resume-signal>Type "approved" if the complete assembly looks correct, or describe any issues with specific parts (e.g., "ring not visible", "ridges missing", "outer mould clips through inner").</resume-signal>
</task>

</tasks>

<verification>
1. Pour hole is a clean cylindrical opening through the ring at the Y=0 split face
2. Pour hole is cut before splitting so both halves get matching semicircular notches
3. Assembly clearance slider controls groove radius (ridgeRadius + clearance)
4. Outer wall thickness slider controls outer mould wall width
5. All mould parameters pass correctly from app.js -> bridge -> worker
6. Complete assembly (proof + inner + outer + ring) renders in both assembled and exploded views
7. All parts regenerate together when profile or settings change
8. All visibility checkboxes work independently
9. No memory leaks from repeated regeneration
</verification>

<success_criteria>
- Pour hole visible as circular opening through the ring
- Clearance slider (0.1-0.8mm) triggers regeneration
- Outer wall thickness slider (1.5-5mm) visibly changes outer mould wall width
- Complete assembly looks correct: inner mould sits inside outer mould, ring connects them at the bottom, plaster cavity gap visible
- Exploded view separates all parts cleanly with correct vertical ordering
- Human verifier approves the visual result
</success_criteria>

<output>
After completion, create `.planning/phases/phase-6/06-03-SUMMARY.md`
</output>
