---
phase: 10-console-bug-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - js/workers/geometryWorker.js
  - js/app.js
autonomous: true

must_haves:
  truths:
    - "Outer mould halves/quarters generate successfully for all preset profiles (cup, bowl, vase, tumbler)"
    - "Ring pieces generate successfully for all preset profiles"
    - "No 'Scene not initialized' warning appears in the console on page load"
    - "All WASM catch blocks log meaningful error messages instead of 'undefined'"
    - "Console is clean on initial load and during normal profile editing"
  artifacts:
    - path: "js/workers/geometryWorker.js"
      provides: "revolveClosedProfile function for annular shapes, safe error extraction"
      contains: "revolveClosedProfile"
    - path: "js/app.js"
      provides: "Correct init ordering -- scene before parametric controls"
  key_links:
    - from: "generateOuterMould"
      to: "revolveClosedProfile"
      via: "direct function call"
      pattern: "revolveClosedProfile\\(outerProfile\\)"
    - from: "generateRing"
      to: "revolveClosedProfile"
      via: "direct function call"
      pattern: "revolveClosedProfile\\(ringProfile\\)"
    - from: "preview3d.initScene"
      to: "initParametricControls"
      via: "execution order in DOMContentLoaded"
---

<objective>
Fix three bugs discovered during user testing of the Pottery Mould Generator:

1. CRITICAL: Outer mould and ring generation always fail because `buildAndRevolve()` closes every profile back through the Z axis (x=0), creating degenerate geometry for annular (tube/washer) shapes.
2. MINOR: `preview3d.initScene()` is called after `initParametricControls()`, which triggers `onProfileChange()` -> `preview3d.updateLatheFallback()` before the scene exists.
3. COSMETIC: WASM/OpenCASCADE errors may not be standard JS Error objects, so `err.message` produces `undefined` in console logs.

Purpose: Make the app fully functional -- outer mould and ring are core value props that currently never generate.
Output: Two patched files (`geometryWorker.js`, `app.js`) with all three bugs fixed.
</objective>

<execution_context>
@/Users/victorhome_1/.claude/get-shit-done/workflows/execute-plan.md
@/Users/victorhome_1/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@js/workers/geometryWorker.js
@js/app.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix annular revolution and error message extraction in geometryWorker.js</name>
  <files>js/workers/geometryWorker.js</files>
  <action>
This task fixes Bug 1 (critical) and Bug 3 (cosmetic) in the geometry worker.

**Bug 1 Fix -- Create `revolveClosedProfile()` for annular shapes:**

Add a new function `revolveClosedProfile(points)` AFTER the existing `buildAndRevolve()` function (after line 292). This function handles rectangular profiles that should NOT close back through the axis -- they close directly back to the first point instead.

```js
/**
 * Build a 2D drawing from a closed rectangular profile and revolve into a 3D solid.
 *
 * Unlike buildAndRevolve(), this function closes the profile directly back to
 * the first point WITHOUT going through the revolution axis (x=0). This is
 * required for annular shapes (outer mould, ring) where the profile is a
 * rectangle far from the axis. Going through x=0 would create a degenerate
 * solid disc instead of an annular tube.
 *
 * @param {Array<{x: number, y: number, type: string}>} points - Rectangular profile points (4 corners).
 * @returns {Object} The revolved replicad shape (caller must track for cleanup).
 */
function revolveClosedProfile(points) {
  let pen = draw([points[0].x, points[0].y]);

  for (let i = 1; i < points.length; i++) {
    const pt = points[i];
    if (pt.type === 'bezier' && pt.cp1 && pt.cp2) {
      pen = pen.cubicBezierCurveTo(
        [pt.x, pt.y],
        [pt.cp1.x, pt.cp1.y],
        [pt.cp2.x, pt.cp2.y]
      );
    } else {
      pen = pen.lineTo([pt.x, pt.y]);
    }
  }

  // Close directly back to the first point (no axis detour)
  const drawing = pen.close();

  // Place on XZ plane and revolve around Z axis
  return drawing.sketchOnPlane('XZ').revolve();
}
```

Then update these call sites to use `revolveClosedProfile` instead of `buildAndRevolve`:

1. **`generateOuterMould()` line 465**: Change `const outerSolid = track(buildAndRevolve(outerProfile));` to `const outerSolid = track(revolveClosedProfile(outerProfile));`

2. **`generateRing()` line 510**: Change `let ringSolid = track(buildAndRevolve(ringProfile));` to `let ringSolid = track(revolveClosedProfile(ringProfile));`

3. **Export path `generateOuterMould` call at line 914**: This is called via `generateOuterMould()` which will already use `revolveClosedProfile` after the change above -- no separate fix needed (the function itself was fixed).

4. **Export path `generateRing` call at line 935**: Same -- `generateRing()` itself was fixed above.

Do NOT change `buildAndRevolve()` itself -- it is correct for pot profiles that start near the axis.

**Bug 3 Fix -- Safe error message extraction:**

Create a helper function at the top of the file (after the imports, around line 38):

```js
/**
 * Safely extract an error message from any thrown value.
 * OpenCASCADE/WASM may throw strings, numbers, or objects without .message.
 * @param {*} err - The caught error value.
 * @returns {string} Human-readable error message.
 */
function safeErrorMessage(err) {
  return err?.message || String(err);
}
```

Then replace ALL bare `.message` accesses in catch blocks with `safeErrorMessage()`:

- Line 214: `error: err.message || String(err)` -> `error: safeErrorMessage(err)` (this one already handles it but should use the helper for consistency)
- Line 671: `shellErr.message` -> `safeErrorMessage(shellErr)`
- Line 673: `${shellErr.message}` -> `${safeErrorMessage(shellErr)}`
- Line 697: `outerErr.message` -> `safeErrorMessage(outerErr)`
- Line 699: `${outerErr.message}` -> `${safeErrorMessage(outerErr)}`
- Line 721: `ringErr.message` -> `safeErrorMessage(ringErr)`
- Line 723: `${ringErr.message}` -> `${safeErrorMessage(ringErr)}`
- Line 869: `e.message` -> `safeErrorMessage(e)`
- Line 909: `shellErr.message` -> `safeErrorMessage(shellErr)`
- Line 930: `outerErr.message` -> `safeErrorMessage(outerErr)`
- Line 951: `ringErr.message` -> `safeErrorMessage(ringErr)`

That is 11 replacements total across the file. Every catch block should use `safeErrorMessage()`.
  </action>
  <verify>
1. Search the file for `revolveClosedProfile` -- should appear: function definition (1), call in generateOuterMould (1), call in generateRing (1) = 3 occurrences minimum.
2. Search the file for `buildAndRevolve` -- should appear: function definition (1), calls in revolveProfile/generateMouldParts/computeVolumes/exportMouldPartsForDownload for pot/inner-mould profiles = 5 occurrences. Should NOT appear in generateOuterMould or generateRing.
3. Search the file for `\.message` (bare property access) -- should appear 0 times outside the safeErrorMessage helper itself. All catch blocks should use `safeErrorMessage()`.
4. Search for `safeErrorMessage` -- should appear 12 times (1 definition + 11 usages).
  </verify>
  <done>
- `revolveClosedProfile()` function exists and is used by `generateOuterMould()` and `generateRing()`
- `buildAndRevolve()` is only used for pot profiles (proof, inner mould) that naturally start near the axis
- All 11 catch-block error references use `safeErrorMessage()` instead of bare `.message`
- No `.message` property access remains in any catch block
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix scene initialization ordering in app.js</name>
  <files>js/app.js</files>
  <action>
This task fixes Bug 2 (minor) -- the Three.js scene must be initialized BEFORE `initParametricControls()` because that function calls `applyPreset('cup')` -> `regenerateFromSliders()` -> `profileEditor.setProfileData()` -> fires `onChange(points)` -> `onProfileChange()` -> `preview3d.updateLatheFallback()` which needs the scene to exist.

In the `DOMContentLoaded` handler, move the scene initialization block:

```js
// Initialize Three.js scene (immediate -- no async needed)
preview3d.initScene(container);
log('Three.js scene initialized');
```

From its CURRENT location at lines 1289-1291 (after `initReferenceImage()`) to IMMEDIATELY AFTER the profile editor initialization block (after line 1236, before `initParametricControls()`).

The new ordering should be:

```
1. DOM references (existing, unchanged)
2. URL design decode (existing, unchanged)
3. Profile editor init (existing, lines 1227-1236)
4. >>> Three.js scene init (MOVED HERE) <<<
5. >>> Instant LatheGeometry preview (MOVED HERE) <<<
6. initParametricControls() (existing, line 1239)
7. initMouldSettings() (existing)
8. initViewControls() (existing)
9. initExportControls() (existing)
10. initEmailGate() (existing)
... rest unchanged
```

Also move the "Instant 3D preview" block (lines 1293-1298) to right after the scene init:

```js
// Instant 3D preview: show LatheGeometry from the initial profile
preview3d.updateLatheFallback(initialPoints);
lastProfilePoints = initialPoints;
updatePreviewStatus('Preview');
log('Instant LatheGeometry preview shown');
```

This way the scene AND the initial lathe preview are both ready before `initParametricControls()` fires its first `onChange`.

Remove both blocks from their old locations (lines 1289-1298) to avoid duplication.

The old location at lines 1289-1298 should be completely removed -- do not leave dead code or duplicate calls.
  </action>
  <verify>
1. In app.js, search for `preview3d.initScene` -- should appear exactly once, BEFORE `initParametricControls`.
2. In app.js, search for `updateLatheFallback(initialPoints)` -- should appear exactly once, right after `initScene`.
3. Verify the ordering: `initProfileEditor` -> `initScene` -> `updateLatheFallback` -> `initParametricControls`. These four calls should appear in this exact order in the DOMContentLoaded handler.
4. No duplicate `initScene` or `updateLatheFallback(initialPoints)` calls exist in the file.
  </verify>
  <done>
- `preview3d.initScene(container)` is called BEFORE `initParametricControls()` in the DOMContentLoaded handler
- The initial LatheGeometry preview is shown BEFORE any code that could trigger `onProfileChange`
- No "Scene not initialized" warning appears because the scene exists before any preview updates fire
- No duplicate init calls exist
  </done>
</task>

</tasks>

<verification>
After both tasks are complete, verify the following across both files:

1. **geometryWorker.js structural checks:**
   - `revolveClosedProfile` function is defined after `buildAndRevolve`
   - `generateOuterMould` calls `revolveClosedProfile` (not `buildAndRevolve`)
   - `generateRing` calls `revolveClosedProfile` (not `buildAndRevolve`)
   - `safeErrorMessage` helper is defined near the top
   - Zero bare `.message` accesses in catch blocks (outside the helper)

2. **app.js structural checks:**
   - `preview3d.initScene(container)` appears BEFORE `initParametricControls()`
   - `preview3d.updateLatheFallback(initialPoints)` appears right after `initScene`
   - No duplicates of either call

3. **No regressions:**
   - `buildAndRevolve` is still used for: `revolveProfile()`, `generateMouldParts()` (proof + inner mould), `computeVolumes()`, `exportMouldPartsForDownload()` (proof + inner mould)
   - `revolveClosedProfile` is only used for outer mould and ring
   - All existing imports, exports, and function signatures are unchanged
</verification>

<success_criteria>
1. Outer mould generation path uses `revolveClosedProfile()` which closes the rectangular profile directly without going through x=0 -- producing a proper annular tube instead of a degenerate disc
2. Ring generation path uses `revolveClosedProfile()` for the same reason
3. Scene is initialized before any code path can trigger `preview3d.updateLatheFallback()`, eliminating the "Scene not initialized" warning
4. All error catch blocks use `safeErrorMessage()` to safely handle WASM errors that may not have a `.message` property
5. No functional regressions in pot profile revolution, inner mould generation, or export pipeline
</success_criteria>

<output>
After completion, create `.planning/phases/phase-10/10-01-SUMMARY.md`
</output>
