---
phase: 03-editor-extended
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - js/presets/parametricPresets.js
  - js/profileEditor.js
  - js/app.js
  - index.html
  - css/style.css
autonomous: true

must_haves:
  truths:
    - "User can select a parametric preset (cup, bowl, vase, tumbler) and see a profile appear immediately"
    - "Sliders for height, rim diameter, belly width, and foot diameter reshape the profile in real time"
    - "User can switch from parametric mode to freehand mode and the current profile carries over for direct editing"
    - "User can switch from freehand mode to parametric mode and a preset profile replaces the current shape"
    - "Changing a preset resets sliders to that preset's defaults and regenerates the profile"
    - "Slider changes trigger the existing 3D preview pipeline via the editor's onChange callback"
  artifacts:
    - path: "js/presets/parametricPresets.js"
      provides: "Pure functions generating ProfilePoint[] from parameters for four presets"
      exports: ["PRESET_DEFAULTS", "PRESET_SLIDER_RANGES", "generatePresetProfile"]
    - path: "index.html"
      provides: "Preset selector dropdown, four parameter sliders, mode toggle buttons"
      contains: "select#preset-selector"
    - path: "js/profileEditor.js"
      provides: "Mode-aware editor that disables edit/draw tools in parametric mode"
      exports: ["initProfileEditor"]
    - path: "js/app.js"
      provides: "Wiring between preset selector, sliders, mode toggle, and editor"
      contains: "switchMode"
  key_links:
    - from: "js/presets/parametricPresets.js"
      to: "js/app.js"
      via: "import generatePresetProfile"
      pattern: "import.*generatePresetProfile.*parametricPresets"
    - from: "js/app.js"
      to: "js/profileEditor.js"
      via: "editor.setProfileData(profile)"
      pattern: "setProfileData"
    - from: "index.html slider input events"
      to: "js/app.js regenerate function"
      via: "addEventListener('input', regenerate)"
      pattern: "addEventListener.*input.*regenerate"
---

<objective>
Create a parametric preset system with four pottery shapes (cup, bowl, vase, tumbler) driven by named sliders, and implement mode switching between parametric and freehand bezier editing.

Purpose: This is the primary new entry point for users who lack drawing skills. Instead of drawing from scratch, they select a pot shape and adjust sliders. The existing freehand editor remains available for advanced users. Both modes produce the same ProfilePoint[] data format and feed the same 3D preview pipeline.

Output: A new `js/presets/parametricPresets.js` module with pure preset generation functions, UI controls (dropdown + sliders + mode toggle) in index.html, CSS for the new controls, and wiring in app.js that connects everything through the existing `setProfileData()` / `onChange` pipeline.
</objective>

<execution_context>
@/Users/victorhome_1/.claude/get-shit-done/workflows/execute-plan.md
@/Users/victorhome_1/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/phase-3/RESEARCH.md

Key existing files to reference:
@js/profileData.js (ProfilePoint format: {x, y, type, cp1?, cp2?})
@js/profileEditor.js (initProfileEditor returns {getProfileData, setProfileData})
@js/app.js (DOMContentLoaded init, onProfileChange pipeline)
@js/profileEditor/canvasSetup.js (Paper.js layers, coordinate transform)
@index.html (current layout: toolbar, canvas, aside#controls)
@css/style.css (Pottery Academy brand variables, existing layout)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Parametric preset generator module</name>
  <files>js/presets/parametricPresets.js</files>
  <action>
Create `js/presets/parametricPresets.js` as an ES module with ZERO DOM or Paper.js dependencies. This is a pure math module.

Export three things:

1. `PRESET_DEFAULTS` object with default parameter values for each preset:
   - cup: { height: 90, rimDiameter: 80, bellyWidth: 85, footDiameter: 55 }
   - bowl: { height: 65, rimDiameter: 150, bellyWidth: 155, footDiameter: 70 }
   - vase: { height: 200, rimDiameter: 60, bellyWidth: 130, footDiameter: 70 }
   - tumbler: { height: 110, rimDiameter: 80, bellyWidth: 78, footDiameter: 65 }

2. `PRESET_SLIDER_RANGES` object with min/max for each parameter per preset:
   - cup: height 60-130, rimDiameter 60-120, bellyWidth 60-130, footDiameter 30-80
   - bowl: height 30-100, rimDiameter 100-250, bellyWidth 100-260, footDiameter 40-120
   - vase: height 100-350, rimDiameter 30-100, bellyWidth 60-200, footDiameter 30-100
   - tumbler: height 70-160, rimDiameter 55-110, bellyWidth 55-115, footDiameter 40-90

3. `generatePresetProfile(presetName, params)` function that returns a `ProfilePoint[]` array.

Each preset generates 6 profile points (foot-to-rim) using the profile data format from profileData.js:
- Point 0: foot bottom { x: footR, y: 0, type: 'line' }
- Point 1: foot top { x: footR, y: 3, type: 'line' } (3mm foot height, constant)
- Point 2: foot-to-body transition { x: footR * factor, y: transitionY, type: 'line' } -- the "tuck" inward
- Point 3: belly { x: bellyR, y: bellyY, type: 'bezier', cp1: {...}, cp2: {...} }
- Point 4: body-to-rim { x: nearRimR, y: bodyTopY, type: 'bezier', cp1: {...}, cp2: {...} }
- Point 5: rim { x: rimR, y: h, type: 'line' }

Preset-specific differences (derive from RESEARCH.md Pattern 1 and Parametric Shape Mathematics section):
- Cup: bellyY = h * 0.55, transition tucks in to footR * 0.85, gentle flare
- Bowl: bellyY = h * 0.45, wider transition zone, rim much wider than foot
- Vase: bellyY = h * 0.40, dramatic belly bulge, narrow rim relative to belly
- Tumbler: bellyY = h * 0.60, nearly straight-sided, foot close to rim width

Control point placement for the belly bezier (point 3):
- cp1: { x: footR * cpFactor, y: h * verticalFactor1 } -- biased toward foot side
- cp2: { x: bellyR * cpFactor, y: bellyY * verticalFactor2 } -- biased toward belly side
Exact factors vary per preset to produce natural pottery curves. Start with the cup formula from RESEARCH.md and adjust proportions for each shape.

Control point placement for body-to-rim bezier (point 4):
- cp1: near belly x, y between belly and rim
- cp2: near rim x, y slightly below rim

Clamp all x values to Math.max(0.1, x) to prevent axis-crossing geometry errors. Round all coordinates to 2 decimal places.

If presetName is not recognized, fall back to 'cup' defaults.
  </action>
  <verify>
Open browser devtools console and run:
```javascript
import { generatePresetProfile, PRESET_DEFAULTS } from './js/presets/parametricPresets.js';
const cupPoints = generatePresetProfile('cup', PRESET_DEFAULTS.cup);
console.log(cupPoints);
// Verify: array of 6 points, first/last are 'line', middle two are 'bezier'
// Verify: all x >= 0, all y >= 0
// Verify: cup height is 90 (last point y), rim radius is 40 (last point x)
const bowlPoints = generatePresetProfile('bowl', PRESET_DEFAULTS.bowl);
console.log('Bowl points:', bowlPoints.length, 'height:', bowlPoints[5].y);
const vasePoints = generatePresetProfile('vase', PRESET_DEFAULTS.vase);
console.log('Vase points:', vasePoints.length, 'height:', vasePoints[5].y);
```
All four presets produce 6 valid points each with no NaN or negative values.
  </verify>
  <done>
`generatePresetProfile()` returns valid ProfilePoint[] for all four presets. `PRESET_DEFAULTS` and `PRESET_SLIDER_RANGES` are exported. No DOM or Paper.js dependencies.
  </done>
</task>

<task type="auto">
  <name>Task 2: UI controls, mode switching, and slider wiring</name>
  <files>index.html, css/style.css, js/profileEditor.js, js/app.js</files>
  <action>
**index.html changes:**

In `aside#controls`, add a new section ABOVE the existing `#dimension-inputs` div. This new section contains:

1. Mode toggle buttons (parametric / freehand):
```html
<div id="mode-controls">
  <h3>Design Mode</h3>
  <div class="mode-toggle">
    <button id="btn-mode-parametric" class="mode-btn active">Parametric</button>
    <button id="btn-mode-freehand" class="mode-btn">Freehand</button>
  </div>
</div>
```

2. Parametric controls panel (visible when in parametric mode):
```html
<div id="parametric-controls">
  <div class="preset-field">
    <label for="preset-selector">Shape</label>
    <select id="preset-selector">
      <option value="cup">Cup</option>
      <option value="bowl">Bowl</option>
      <option value="vase">Vase</option>
      <option value="tumbler">Tumbler</option>
    </select>
  </div>
  <div class="slider-field">
    <label for="slider-height">Height</label>
    <input type="range" id="slider-height" />
    <span class="slider-value" id="val-height">--</span>
    <span class="slider-unit">mm</span>
  </div>
  <div class="slider-field">
    <label for="slider-rim-diameter">Rim diameter</label>
    <input type="range" id="slider-rim-diameter" />
    <span class="slider-value" id="val-rim-diameter">--</span>
    <span class="slider-unit">mm</span>
  </div>
  <div class="slider-field">
    <label for="slider-belly-width">Belly width</label>
    <input type="range" id="slider-belly-width" />
    <span class="slider-value" id="val-belly-width">--</span>
    <span class="slider-unit">mm</span>
  </div>
  <div class="slider-field">
    <label for="slider-foot-diameter">Foot diameter</label>
    <input type="range" id="slider-foot-diameter" />
    <span class="slider-value" id="val-foot-diameter">--</span>
    <span class="slider-unit">mm</span>
  </div>
</div>
```

**css/style.css changes:**

Add styles for the new controls (after the existing `#dimension-inputs` styles):

- `#mode-controls`: margin-bottom 1.25rem, padding-bottom 1rem, border-bottom 1px solid var(--border)
- `.mode-toggle`: display flex, gap 0, border-radius 6px, overflow hidden, border 1px solid var(--border)
- `.mode-btn`: flex 1, padding 0.5rem, font-size 0.8rem, border none, background #fff, cursor pointer, transition 0.15s
- `.mode-btn.active`: background var(--terra-cotta), color var(--cream)
- `#parametric-controls`: margin-bottom 1.25rem, padding-bottom 1rem, border-bottom 1px solid var(--border)
- `.preset-field`: display flex, justify-content space-between, align-items center, margin-bottom 0.75rem
- `.preset-field select`: padding 0.35rem 0.5rem, border-radius 4px, border 1px solid var(--border), font-size 0.85rem, background #fff, color var(--dark)
- `.preset-field select:focus`: outline none, border-color var(--terra-cotta), box-shadow matching dim-input focus style
- `.slider-field`: display flex, align-items center, gap 8px, margin-bottom 0.6rem
- `.slider-field label`: font-size 0.8rem, color #555, min-width 90px, flex-shrink 0
- `.slider-field input[type="range"]`: flex 1, accent-color var(--terra-cotta), height 4px
- `.slider-value`: font-size 0.8rem, font-weight 600, min-width 32px, text-align right, color var(--dark)
- `.slider-unit`: font-size 0.75rem, color #888

**js/profileEditor.js changes:**

Extend the returned public API object to include two new methods:

1. `setToolsEnabled(enabled)`: When `enabled` is false, deactivate editTool and drawTool (so user cannot drag points), visually disable the Edit/Draw toolbar buttons. When true, re-activate editTool and re-enable buttons. This is called by app.js when entering/leaving parametric mode.

2. Keep the existing `getProfileData()` and `setProfileData()` unchanged -- they already do exactly what parametric mode needs.

Implementation of `setToolsEnabled(enabled)`:
- Store the `enabled` state in a variable
- When disabled: call `paper.tool = null` to deactivate current tool, add 'disabled' class to btnEdit and btnDraw
- When enabled: activate editTool, remove 'disabled' class, call setActiveButton(btnEdit)
- The toolbar buttons' click handlers should check this state and return early if disabled

**js/app.js changes:**

Import `generatePresetProfile`, `PRESET_DEFAULTS`, `PRESET_SLIDER_RANGES` from `./presets/parametricPresets.js`.
Import `createProfile` from `./profileData.js` (already imported).

Add mode state at module level:
```javascript
let currentMode = 'parametric'; // 'parametric' | 'freehand'
let currentPreset = 'cup';
```

In the DOMContentLoaded handler, AFTER profileEditor init:

1. Initialize parametric controls:
   - Call `initParametricControls()` which:
     a. Gets references to preset-selector, all four sliders, all four value displays, mode buttons
     b. Calls `applyPreset('cup')` to set initial slider ranges/values from PRESET_DEFAULTS and PRESET_SLIDER_RANGES
     c. Wires `preset-selector` change event to call `applyPreset(selectedValue)` and `regenerateFromSliders()`
     d. Wires each slider's `input` event to call `regenerateFromSliders()` AND update the corresponding value span
     e. Wires `btn-mode-parametric` click to call `switchMode('parametric')`
     f. Wires `btn-mode-freehand` click to call `switchMode('freehand')`

2. `applyPreset(presetName)` function:
   - Sets `currentPreset = presetName`
   - Gets defaults from `PRESET_DEFAULTS[presetName]`
   - Gets ranges from `PRESET_SLIDER_RANGES[presetName]`
   - For each slider: set min, max, value, step=1, and update value display span
   - Call `regenerateFromSliders()`

3. `regenerateFromSliders()` function:
   - Read current values from all four sliders
   - Build params object: { height, rimDiameter, bellyWidth, footDiameter }
   - Call `generatePresetProfile(currentPreset, params)`
   - Call `profileEditor.setProfileData(createProfile(points))`
   - The editor's onChange callback fires automatically, updating 3D preview

4. `switchMode(mode)` function:
   - If mode === currentMode, return
   - Set `currentMode = mode`
   - Update mode button active states
   - If mode === 'parametric':
     - Show #parametric-controls, call `profileEditor.setToolsEnabled(false)`
     - Regenerate from current sliders: `regenerateFromSliders()`
   - If mode === 'freehand':
     - Hide #parametric-controls, call `profileEditor.setToolsEnabled(true)`
     - The current profile stays in the editor (carried over from parametric)

5. Change the initial profile from `getTestProfile()` to `generatePresetProfile('cup', PRESET_DEFAULTS.cup)` wrapped in `createProfile()`. This makes the app start in parametric mode with a cup preset.

6. After editor init, call `profileEditor.setToolsEnabled(false)` since we start in parametric mode.

IMPORTANT: Do NOT remove the existing Phase 1 test harness buttons or preview code. They coexist in the aside. Place the mode/parametric controls at the TOP of the aside, before `#dimension-inputs`.
  </action>
  <verify>
1. Open the app in a browser. The aside should show: Mode toggle (Parametric active) -> Preset selector (Cup) -> Four sliders with values -> Dimensions readout -> Phase 1 test harness.
2. Move any slider -- the 2D profile on the canvas should update in real time. The dimension readouts should update. The 3D preview should update (if WASM loaded).
3. Change preset dropdown to "bowl" -- sliders should reset to bowl defaults, profile should change to a wider/shallower shape.
4. Change to "vase" -- profile should show narrow rim, wide belly.
5. Click "Freehand" mode button -- parametric controls should hide, Edit/Draw toolbar buttons should become active, the current profile should remain editable by dragging points.
6. Click "Parametric" mode button -- parametric controls reappear, Edit/Draw buttons become disabled, profile regenerates from sliders.
  </verify>
  <done>
Four presets selectable via dropdown. Sliders reshape profile in real time. Mode toggle switches between parametric (sliders control shape) and freehand (direct bezier editing). Profile carries over when switching to freehand. 3D preview updates via existing onChange pipeline.
  </done>
</task>

</tasks>

<verification>
1. All four presets generate valid profiles (6 points, foot-to-rim, no NaN, no negative x/y)
2. Slider drag produces smooth real-time profile updates without lag
3. Preset change resets sliders and regenerates profile
4. Mode switch from parametric to freehand keeps current profile and enables direct editing
5. Mode switch from freehand to parametric disables editing tools and regenerates from sliders
6. Dimension inputs panel still functions in freehand mode
7. Undo/redo still works in freehand mode
8. No console errors during any interaction
</verification>

<success_criteria>
- User selects cup/bowl/vase/tumbler from dropdown and sees distinct pottery shapes
- Moving any slider visually changes the profile and 3D preview
- Parametric -> Freehand transition preserves the shape and enables point dragging
- Freehand -> Parametric transition regenerates the preset shape from current slider values
- All existing Phase 2 features (undo, constraints, snap, dimensions) continue to work in freehand mode
</success_criteria>

<output>
After completion, create `.planning/phases/phase-3/03-01-SUMMARY.md`
</output>
