---
phase: 03-editor-extended
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - js/svgImport.js
  - js/referenceImage.js
  - js/profileEditor/canvasSetup.js
  - js/app.js
  - index.html
  - css/style.css
autonomous: true

must_haves:
  truths:
    - "User can upload an SVG file and see it parsed into an editable profile in the editor"
    - "Invalid SVG (no path element found) shows an error message instead of silently failing"
    - "SVG profile renders right-side-up (foot at bottom, rim at top) regardless of SVG coordinate system"
    - "User can upload a reference photo and see it appear behind the profile at reduced opacity"
    - "User can adjust reference photo opacity with a slider from fully transparent to fully visible"
    - "User can remove the reference photo to return to a clean canvas"
  artifacts:
    - path: "js/svgImport.js"
      provides: "SVG file parsing pipeline producing ProfilePoint[]"
      exports: ["importSVGFile"]
    - path: "js/referenceImage.js"
      provides: "Reference image overlay management with opacity control"
      exports: ["loadReferenceImage", "clearReferenceImage", "setReferenceOpacity"]
    - path: "js/profileEditor/canvasSetup.js"
      provides: "Updated layer setup with reference layer at index 0 (below grid)"
      contains: "reference"
    - path: "index.html"
      provides: "SVG upload button, reference image upload, opacity slider, clear button"
      contains: "input-svg-upload"
  key_links:
    - from: "index.html SVG file input"
      to: "js/svgImport.js importSVGFile"
      via: "FileReader.readAsText -> importSVGFile"
      pattern: "importSVGFile"
    - from: "js/svgImport.js"
      to: "js/app.js"
      via: "returns ProfilePoint[] -> createProfile -> setProfileData"
      pattern: "setProfileData"
    - from: "index.html image file input"
      to: "js/referenceImage.js loadReferenceImage"
      via: "FileReader.readAsDataURL -> loadReferenceImage"
      pattern: "loadReferenceImage"
    - from: "js/referenceImage.js"
      to: "js/profileEditor/canvasSetup.js"
      via: "uses layers.reference for Raster placement"
      pattern: "layers\\.reference"
---

<objective>
Add SVG file import (parse SVG path data into editable ProfilePoint[]) and reference photo overlay (Paper.js Raster with opacity control) to the profile editor.

Purpose: SVG import lets users who already have a profile design in vector format bring it directly into the editor. Reference image overlay lets users trace a photo of an existing pot, which is especially valuable for reproducing pottery forms from reference images.

Output: A `js/svgImport.js` module that parses SVG files via Paper.js importSVG, a `js/referenceImage.js` module that manages a Paper.js Raster on a dedicated layer, updated `canvasSetup.js` with a reference layer, UI controls for file upload and opacity, and wiring in app.js.
</objective>

<execution_context>
@/Users/victorhome_1/.claude/get-shit-done/workflows/execute-plan.md
@/Users/victorhome_1/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/phase-3/RESEARCH.md
@.planning/phases/phase-3/03-01-PLAN.md (prior plan in this phase -- depends on its UI structure)

Key existing files to reference:
@js/profileData.js (ProfilePoint format, createProfile())
@js/profileEditor.js (setProfileData API, editorState.layers, editorState.transform)
@js/profileEditor/canvasSetup.js (initCanvas with 4 layers -- must add reference layer)
@js/profileEditor/pathRenderer.js (syncPathToProfile pattern -- SVG import follows same conversion logic)
@js/app.js (after 03-01: has mode switching, parametric controls, profileEditor reference)
@index.html (after 03-01: has mode-controls, parametric-controls sections in aside)
@css/style.css (after 03-01: has mode-btn, slider-field, preset-field styles)
</context>

<tasks>

<task type="auto">
  <name>Task 1: SVG import module and reference image layer</name>
  <files>js/svgImport.js, js/referenceImage.js, js/profileEditor/canvasSetup.js</files>
  <action>
**js/profileEditor/canvasSetup.js changes:**

Add a `reference` layer as layer 0 (bottom-most, below grid). The layer order becomes:
- Layer 0: reference (reference photo -- below everything)
- Layer 1: grid
- Layer 2: profile
- Layer 3: handles
- Layer 4: overlay

Implementation: In `initCanvas()`, the first layer created by `paper.setup()` (previously named 'grid') should be renamed to 'reference'. Then create the grid layer as a new `paper.Layer()`. The rest follows the same pattern. Return the layers object with the new `reference` key added:
```javascript
return {
  project: paper.project,
  view: paper.view,
  layers: {
    reference: referenceLayer,  // NEW
    grid: gridLayer,
    profile: profileLayer,
    handles: handleLayer,
    overlay: overlayLayer,
  },
};
```

The `profileLayer.activate()` call at the end stays the same.

IMPORTANT: No other existing code references layers by index -- they all use the named keys (`layers.grid`, `layers.profile`, etc.), so adding a layer at position 0 does not break anything.

**js/svgImport.js:**

Create a new ES module. Export one function: `importSVGFile(svgString)`.

This function:
1. Calls `paper.project.importSVG(svgString, { expandShapes: true, insert: false })` to parse the SVG without adding it to the canvas.

2. Finds the first usable Path in the imported item tree using a recursive walker:
```javascript
function findFirstPath(item) {
  if (item instanceof paper.Path && item.segments && item.segments.length >= 2) return item;
  if (item instanceof paper.CompoundPath && item.children) {
    // Use the first child path of a compound path
    for (const child of item.children) {
      if (child instanceof paper.Path && child.segments && child.segments.length >= 2) return child;
    }
  }
  if (item.children) {
    for (const child of item.children) {
      const found = findFirstPath(child);
      if (found) return found;
    }
  }
  return null;
}
```

3. If no path found, throws `new Error('No path found in SVG file. The file must contain at least one <path> element.')`.

4. Normalizes the path into ProfilePoint[] format:
   a. Get the bounding box: `const bounds = svgPath.bounds;`
   b. Calculate scale factor: `const targetHeight = 100; const scaleFactor = targetHeight / bounds.height;`
   c. For each segment in `svgPath.segments`, convert to profile space:
      - x = `(seg.point.x - bounds.left) * scaleFactor` (shift to origin, scale)
      - y = `(bounds.bottom - seg.point.y) * scaleFactor` (Y-FLIP: SVG Y-down -> profile Y-up, then scale)
      - Determine if bezier: `seg.handleIn.length > 0.5` OR previous `seg.handleOut.length > 0.5`
      - For bezier segments, compute cp1 and cp2 in profile space using the same Y-flip:
        - cp1 from previous segment's handleOut: `prevSeg.point.add(prevSeg.handleOut)` -> transform
        - cp2 from this segment's handleIn: `seg.point.add(seg.handleIn)` -> transform
      - Clamp all x values to `Math.max(0, x)`, y values to `Math.max(0, y)`
      - Round to 2 decimal places

   d. Ensure points are ordered foot-to-rim (y ascending). If the first point has a higher y than the last, reverse the array. When reversing, swap cp1/cp2 on bezier points and adjust the segment types (since bezier type belongs to the segment arriving at a point, not departing).

5. Returns the ProfilePoint[] array.

IMPORTANT: This function accesses `paper` globally (from CDN). It does NOT import Paper.js as a module. Same pattern used throughout the codebase.

**js/referenceImage.js:**

Create a new ES module. Export three functions:

1. `loadReferenceImage(dataUrl, referenceLayer, transform)`:
   - Creates `new paper.Raster(dataUrl)`
   - On `raster.onLoad`:
     a. Clear previous reference: `referenceLayer.removeChildren()`
     b. Calculate scale to fit editor: `const editorHeight = transform.scale * 120; const scaleFactor = editorHeight / raster.height;`
     c. Apply scale: `raster.scale(scaleFactor)`
     d. Position with bottom aligned to profile origin:
        ```javascript
        raster.position = new paper.Point(
          transform.offsetX + (raster.bounds.width) / 2,
          transform.offsetY - (raster.bounds.height) / 2
        );
        ```
     e. Set initial opacity: `raster.opacity = 0.3`
     f. Add to layer: `referenceLayer.addChild(raster)`
   - Returns nothing (async via onLoad callback)

2. `clearReferenceImage(referenceLayer)`:
   - Calls `referenceLayer.removeChildren()`

3. `setReferenceOpacity(referenceLayer, opacity)`:
   - Iterates `referenceLayer.children` and sets `child.opacity = opacity` on each
   - Opacity value should be between 0 and 1
  </action>
  <verify>
1. Verify canvasSetup.js creates 5 layers by checking in browser console: `paper.project.layers.map(l => l.name)` should output `['reference', 'grid', 'profile', 'handles', 'overlay']`.
2. Verify existing profile rendering still works (grid visible, profile path visible, handles visible) -- adding the reference layer should not break anything.
3. Test SVG import manually in console:
```javascript
import { importSVGFile } from './js/svgImport.js';
const testSVG = '<svg xmlns="http://www.w3.org/2000/svg"><path d="M 10 100 C 10 50 30 20 30 0 L 40 0 C 40 20 50 50 50 100 Z"/></svg>';
const points = importSVGFile(testSVG);
console.log(points); // Should be array of ProfilePoint objects with y-values increasing
```
  </verify>
  <done>
canvasSetup.js has 5 layers with reference at bottom. svgImport.js parses SVG strings into valid ProfilePoint[] with correct Y-flip. referenceImage.js manages Raster overlay with opacity control. Existing editor rendering unaffected.
  </done>
</task>

<task type="auto">
  <name>Task 2: UI controls and wiring for SVG import and reference image</name>
  <files>index.html, css/style.css, js/app.js</files>
  <action>
**index.html changes:**

Add a new section in `aside#controls` AFTER the `#parametric-controls` div and BEFORE `#dimension-inputs`. This section contains file import controls:

```html
<div id="import-controls">
  <h3>Import</h3>
  <div class="import-row">
    <label class="import-btn" for="input-svg-upload">
      Upload SVG
      <input type="file" id="input-svg-upload" accept=".svg" hidden />
    </label>
    <label class="import-btn" for="input-ref-image">
      Reference Photo
      <input type="file" id="input-ref-image" accept="image/*" hidden />
    </label>
  </div>
  <div id="ref-image-controls" class="hidden">
    <div class="slider-field">
      <label for="slider-ref-opacity">Opacity</label>
      <input type="range" id="slider-ref-opacity" min="0" max="1" step="0.05" value="0.3" />
      <span class="slider-value" id="val-ref-opacity">30%</span>
    </div>
    <button id="btn-clear-ref" class="btn-secondary">Remove Photo</button>
  </div>
</div>
```

The `import-btn` is a styled label that triggers the hidden file input on click. The `ref-image-controls` div is hidden by default and shown when a reference image is loaded.

**css/style.css changes:**

Add styles for the import controls (after the parametric-controls styles added in 03-01):

- `#import-controls`: margin-bottom 1.25rem, padding-bottom 1rem, border-bottom 1px solid var(--border)
- `#import-controls h3`: margin 0 0 0.75rem, font-size 0.95rem
- `.import-row`: display flex, gap 8px
- `.import-btn`: flex 1, padding 0.5rem 0.75rem, font-size 0.8rem, font-weight 500, text-align center, background #fff, border 1px solid var(--border), border-radius 4px, cursor pointer, transition 0.15s, color var(--dark)
- `.import-btn:hover`: border-color var(--terra-cotta), background rgba(194, 149, 107, 0.08)
- `#ref-image-controls`: margin-top 0.75rem
- `.btn-secondary`: background transparent, border 1px solid var(--border), color var(--dark), font-size 0.8rem, padding 0.4rem 0.75rem, width 100%
- `.btn-secondary:hover`: border-color var(--terra-cotta), color var(--terra-cotta-dark)

**js/app.js changes:**

Import the new modules at the top:
```javascript
import { importSVGFile } from './svgImport.js';
import { loadReferenceImage, clearReferenceImage, setReferenceOpacity } from './referenceImage.js';
```

In the DOMContentLoaded handler, AFTER the parametric controls init (from 03-01), add:

1. SVG upload wiring:
```javascript
const svgInput = document.getElementById('input-svg-upload');
if (svgInput) {
  svgInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (evt) => {
      try {
        const svgString = evt.target.result;
        const points = importSVGFile(svgString);

        if (points.length < 2) {
          alert('SVG produced too few points. Please use an SVG with a simple path.');
          return;
        }

        // Switch to freehand mode (imported SVG is for direct editing)
        switchMode('freehand');

        const profile = createProfile(points);
        profileEditor.setProfileData(profile);
      } catch (err) {
        alert(err.message);
      }
    };
    reader.readAsText(file);

    // Reset file input so the same file can be re-uploaded
    svgInput.value = '';
  });
}
```

Note: After SVG import, the editor automatically switches to freehand mode because the imported profile is meant for direct bezier editing, not parametric slider control.

2. Reference image upload wiring:
```javascript
const refImageInput = document.getElementById('input-ref-image');
const refImageControls = document.getElementById('ref-image-controls');
const sliderRefOpacity = document.getElementById('slider-ref-opacity');
const valRefOpacity = document.getElementById('val-ref-opacity');
const btnClearRef = document.getElementById('btn-clear-ref');

if (refImageInput) {
  refImageInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (evt) => {
      const dataUrl = evt.target.result;
      // Access layers and transform from the editor's internal state
      // We need to pass the reference layer -- get it from the editor
      const layers = getLayers();  // see below
      const transform = getTransform();  // see below

      loadReferenceImage(dataUrl, layers.reference, transform);

      // Show opacity controls
      if (refImageControls) refImageControls.classList.remove('hidden');
      // Reset opacity slider
      if (sliderRefOpacity) sliderRefOpacity.value = 0.3;
      if (valRefOpacity) valRefOpacity.textContent = '30%';
    };
    reader.readAsDataURL(file);

    // Reset file input
    refImageInput.value = '';
  });
}

if (sliderRefOpacity) {
  sliderRefOpacity.addEventListener('input', (e) => {
    const opacity = parseFloat(e.target.value);
    const layers = getLayers();
    setReferenceOpacity(layers.reference, opacity);
    if (valRefOpacity) valRefOpacity.textContent = `${Math.round(opacity * 100)}%`;
  });
}

if (btnClearRef) {
  btnClearRef.addEventListener('click', () => {
    const layers = getLayers();
    clearReferenceImage(layers.reference);
    if (refImageControls) refImageControls.classList.add('hidden');
  });
}
```

3. To access the editor's layers and transform, extend the public API of `initProfileEditor()` in `js/profileEditor.js`:

Add two new methods to the returned object:
```javascript
getLayers() {
  return layers;
},
getTransform() {
  return transform;
},
```

Then in app.js, create helper functions:
```javascript
function getLayers() { return profileEditor.getLayers(); }
function getTransform() { return profileEditor.getTransform(); }
```

This cleanly exposes the layer/transform references needed by the reference image system without breaking encapsulation.

IMPORTANT: The reference image persists across mode switches. It is not tied to parametric or freehand mode -- it is a background overlay that helps with both. Do NOT clear it on mode switch.
  </action>
  <verify>
1. Open app in browser. The Import section should appear between parametric controls and dimensions, with "Upload SVG" and "Reference Photo" buttons.
2. Click "Upload SVG", select a simple SVG file with a path element. The profile should change to match the SVG shape, and the editor should switch to freehand mode automatically.
3. Upload an SVG with no path element (e.g., just a rect without expandShapes working). Should show an alert error message.
4. Click "Reference Photo", select a JPG/PNG of a pot. The image should appear behind the profile at 30% opacity.
5. Move the opacity slider -- the reference image should smoothly fade from invisible to fully opaque.
6. Click "Remove Photo" -- the reference image should disappear and the opacity controls should hide.
7. Upload a reference image, then switch between parametric and freehand modes -- the reference image should stay visible through mode switches.
8. All existing features (presets, sliders, freehand editing, undo/redo, constraints, dimensions) still work.
  </verify>
  <done>
SVG upload parses files into editable profiles with auto-switch to freehand mode. Reference photo overlay shows behind the profile with adjustable opacity. Remove button clears the overlay. Both features integrate cleanly with the existing editor and the parametric system from 03-01.
  </done>
</task>

</tasks>

<verification>
1. SVG import produces a valid ProfilePoint[] with correct Y-flip (foot at bottom, rim at top)
2. SVG import handles both simple paths and paths nested inside groups
3. SVG with no usable path shows a clear error message
4. Reference image loads behind the grid (reference layer is below grid layer)
5. Opacity slider controls reference image transparency from 0 to 1
6. Reference image persists across mode switches (parametric <-> freehand)
7. Clear button removes the image and hides opacity controls
8. canvasSetup.js produces 5 layers in correct order: reference, grid, profile, handles, overlay
9. All Phase 2 features (undo, redo, constraints, snap, grid, dimensions) still work
10. No console errors during SVG import, image upload, opacity change, or image removal
</verification>

<success_criteria>
- User uploads an SVG and sees it become an editable bezier profile
- User uploads a photo and sees it at adjustable opacity behind the profile for tracing
- User can remove the reference photo to return to a clean canvas
- SVG import auto-switches to freehand mode for direct editing
- Reference image survives mode switches between parametric and freehand
- Existing Phase 2 and Phase 3 Plan 01 features are fully functional
</success_criteria>

<output>
After completion, create `.planning/phases/phase-3/03-02-SUMMARY.md`
</output>
